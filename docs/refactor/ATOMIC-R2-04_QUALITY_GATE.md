# ATOMIC-R2-04_QUALITY_GATE
**일자**: 2026-01-05
**상태**: **완료 (VERIFIED)**

## 1. 개요
리포트 생성 파이프라인의 최종 단계에서 데이터 무결성과 문장 품질을 검증하는 **품질 게이트(Quality Gate)**를 강제 적용했습니다. 이는 구조적 결함이나 저품질 문장이 사용자에게 전달되는 것을 원천 차단합니다.

## 2. 주요 검증 규칙

| 구분 | 규칙 | 위반 시 조치 |
| :--- | :--- | :--- |
| **구조 무결성** | 필수 4개 섹션(요약, 원국, 대운, 일진) 존재 여부 | 즉시 Reject (에러 발생) |
| **필드 완결성** | 각 섹션의 `result`, `explain`, `interpretation` 존재 (최소 5자) | 즉시 Reject |
| **데이터 정합성** | `LifeFlow` 섹션 내 대운 버킷 9개(10대~90대) 존재 여부 | 즉시 Reject |
| **금칙어 필터링** | Placeholder(TBD, null 등) 및 일반론적 문구 차단 | 1회 삭제 복구 시도, 실패 시 Reject |
| ** Barnum 대응** | "무난합니다", "운에 맡기세요" 등 무책임한 표현 차단 | 1회 삭제 복구 시도, 실패 시 Reject |

## 3. 실패 코드 및 UX 정책
- **에러 코드**: `failed-precondition` (HTTP 400)
- **메시지**: "분석 리포트 품질 검증에 실패했습니다. 다시 시도해주시거나 관리자에게 문의해주세요."
- **사용자 노출**: 프론트엔드에서는 해당 에러 수신 시 "품질 검증 실패" 안내와 함께 **재발행 버튼**을 유도하는 정책을 권장합니다.

## 4. 검증 결과
- `bannedPhrases.ts`: 금칙어 및 패턴 대폭 확장.
- `reportValidator.ts`: 구조적 무결성 및 필드 길이 체크 강화.
- `gate.ts`: 통합 검증 및 자동 복구 로직 구현.
- `functions/src/index.ts`: 파이프라인 연결 및 전용 에러 핸들링 완료.

---
**보고자**: QA 게이트 엔지니어
**판정**: **PASS - 고위험 리포트 차단 체계 확립.**
