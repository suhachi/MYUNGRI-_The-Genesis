import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { execSync } from 'child_process';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const pkg = JSON.parse(fs.readFileSync(path.join(__dirname, '../package.json'), 'utf-8'));

let commitHash = 'unknown';
try {
  commitHash = execSync('git rev-parse --short HEAD').toString().trim();
} catch (e) {
  console.warn('[BuildInfo] Failed to get git commit hash');
}

const buildTimeISO = new Date().toISOString();
const appVersion = pkg.version || '0.0.0';

// Simple build info content
const content = `// This file is auto-generated by scripts/gen-build-info.mjs
export const buildInfo = {
  buildTimeISO: "${buildTimeISO}",
  appVersion: "${appVersion}",
  commitHash: "${commitHash}",
  env: "${process.env.NODE_ENV || 'production'}"
};
`;

const outputPath = path.join(__dirname, '../src/buildInfo.ts');
fs.writeFileSync(outputPath, content, 'utf-8');

console.log(`[BuildInfo] Generated stamp: ${appVersion} at ${buildTimeISO}`);
